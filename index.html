<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ma S√≥i ‚Äì Host Mobile</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #050816;
      color: #e5e7eb;
    }
    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 12px 14px 24px;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 1.4rem;
    }
    .subtitle {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 10px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(96, 165, 250, 0.15);
      border: 1px solid rgba(96, 165, 250, 0.4);
      color: #bfdbfe;
      margin-bottom: 10px;
    }
    .card {
      background: #020617;
      border-radius: 14px;
      padding: 10px 10px 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 14px 30px rgba(0,0,0,0.6);
      margin-bottom: 10px;
    }
    .card h2 {
      margin: 0 0 6px;
      font-size: 1.05rem;
    }
    .small { font-size: 0.78rem; }
    .hint {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 4px;
    }
    input[type="text"], select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 0.9rem;
      margin-top: 4px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(96,165,250,0.4);
    }
    button {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 9px 10px;
      font-size: 0.9rem;
      margin-top: 6px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
    }
    button.primary {
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: #052e16;
      box-shadow: 0 10px 20px rgba(22,163,74,0.4);
    }
    button.secondary {
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.4);
    }
    button.danger {
      background: rgba(248,113,113,0.12);
      color: #fecaca;
      border: 1px solid rgba(248,113,113,0.8);
    }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
    }
    .row-2 {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }
    .row-2 > * { flex: 1; }

    .player-card {
      background: #020617;
      border-radius: 10px;
      padding: 6px 8px;
      margin-top: 6px;
      border: 1px solid rgba(51,65,85,0.9);
      font-size: 0.83rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .player-card.dead { opacity: 0.55; }
    .pill {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 0.7rem;
      margin-left: 4px;
    }
    .pill.alive {
      background: rgba(34,197,94,0.15);
      color: #bbf7d0;
      border: 1px solid rgba(34,197,94,0.7);
    }
    .pill.dead {
      background: rgba(239,68,68,0.12);
      color: #fecaca;
      border: 1px solid rgba(239,68,68,0.7);
    }
    .pill.muted {
      background: rgba(234,179,8,0.12);
      color: #fef9c3;
      border: 1px solid rgba(234,179,8,0.8);
    }
    .tag-role {
      border-radius: 999px;
      padding: 2px 6px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      font-size: 0.75rem;
    }
    .log-box {
      max-height: 230px;
      overflow-y: auto;
      background: #020617;
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid rgba(31,41,55,0.9);
      font-size: 0.8rem;
    }
    .log-line {
      padding: 3px 0;
      border-bottom: 1px dashed rgba(31,41,55,0.9);
    }
    .phase-label {
      font-size: 0.85rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      display: inline-block;
      background: rgba(15,23,42,0.9);
      margin-bottom: 4px;
    }
    .status-text {
      font-size: 0.8rem;
      color: #e5e7eb;
      margin-bottom: 4px;
    }
    .status-text strong { color: #facc15; }
    .winner-text {
      font-size: 0.9rem;
      margin-top: 4px;
      font-weight: 600;
    }
    .winner-village { color: #bbf7d0; }
    .winner-wolves { color: #fecaca; }
  </style>
</head>
<body>
  <div class="app">
    <h1>Werewolf Manual Host</h1>
    <div class="subtitle">B·∫£n h·ªó tr·ª£ qu·∫£n tr√≤ ¬∑ Ch∆°i b·∫±ng b·ªô b√†i th·∫≠t</div>
    <div class="badge">D√πng t·ªët tr√™n ƒëi·ªán tho·∫°i</div>

    <!-- SETUP -->
    <section class="card">
      <h2>1. Setup ng∆∞·ªùi ch∆°i</h2>
      <div class="small">Nh·∫≠p t√™n + role tr√πng v·ªõi l√° b√†i th·∫≠t.</div>
      <input id="playerNameInput" type="text" placeholder="T√™n (vd: Huy, Duy, ...)" />
      <select id="playerRoleInput" style="margin-top:4px;"></select>
      <button class="secondary" onclick="addPlayer()">‚ûï Th√™m ng∆∞·ªùi ch∆°i</button>
      <div class="row-2">
        <button id="startGameBtn" class="primary" onclick="startGame()">üåô B·∫Øt ƒë·∫ßu v√°n (ƒê√™m 1)</button>
        <button class="danger" onclick="resetAll(true)">‚ôª Reset v√°n</button>
      </div>
      <div class="hint">B·∫•m v√†o th·∫ª ng∆∞·ªùi ch∆°i ƒë·ªÉ chuy·ªÉn <b>S·ªëng ‚Üî Ch·∫øt</b> n·∫øu c·∫ßn ch·ªânh tay.</div>
    </section>

    <!-- PLAYERS -->
    <section class="card">
      <h2>2. Ng∆∞·ªùi ch∆°i (<span id="playerCount">0</span>)</h2>
      <div id="playersList"></div>
    </section>

    <!-- CONTROL -->
    <section class="card">
      <h2>3. ƒêi·ªÅu khi·ªÉn & H√†nh ƒë·ªông ƒë√™m</h2>
      <div id="phaseInfo"></div>
      <div id="statusText" class="status-text"></div>
      <div id="winnerText" class="winner-text"></div>

      <div class="row-2" style="margin-top:6px;">
        <button id="nightBtn" class="secondary" onclick="startNight()">üåô Sang ƒê√äM</button>
        <button id="dayBtn" class="secondary" onclick="startDay()">‚òÄÔ∏è Sang NG√ÄY</button>
      </div>
      <div class="row-2">
        <button id="callBtn" class="secondary" onclick="nextRoleCall()">üì£ G·ªçi role ti·∫øp theo</button>
        <button id="endBtn" class="danger" onclick="forceEndGame()">üõë K·∫øt th√∫c v√°n</button>
      </div>

      <div id="nightActionPanel" style="margin-top:8px;" class="small"></div>
    </section>

    <!-- LOG -->
    <section class="card">
      <h2>4. Log</h2>
      <div id="logBox" class="log-box"></div>
    </section>
  </div>

  <script>
    // ======== C·∫§U H√åNH ROLE & STATE ========

    const ROLES = [
      { id: "werewolf", label: "üê∫ Ma S√≥i" },
      { id: "seer", label: "üîÆ Ti√™n tri" },
      { id: "witch", label: "üß™ Ph√π th·ªßy" },
      { id: "guard", label: "üõ°Ô∏è B·∫£o v·ªá" },
      { id: "gambler", label: "üé≤ Con b·∫°c" },
      { id: "prince", label: "üëë Ho√†ng t·ª≠" },
      { id: "mage", label: "üßô Ph√°p s∆∞" },
      { id: "villager", label: "üë§ D√¢n l√†ng" },
    ];

    const NIGHT_CALL_ORDER = [
      "mage",
      "werewolf",
      "seer",
      "witch",
      "guard",
      "gambler",
      "prince",
    ];

    const state = {
      players: [], // {id, name, role, alive, muted}
      phase: "lobby",
      nightNumber: 0,
      dayNumber: 0,
      currentNightStepIndex: 0,
      logs: [],
      winner: null,
      nightActions: {
        wolfTargetId: null,
        guardTargetId: null,
        witchHeal: null,          // true/false/null
        witchPoisonTargetId: null,
        mageMuteTargetId: null,
        gamblerBetTargetId: null,
      },
      witchUsed: false, // ƒë√£ t·ª´ng d√πng b√¨nh (c·ª©u, ƒë·ªôc, ho·∫∑c c·∫£ hai)
    };

    // ======== TI·ªÜN √çCH ========

    function roleLabel(id) {
      const r = ROLES.find(r => r.id === id);
      return r ? r.label : id;
    }

    function addLog(text) {
      state.logs.unshift(text);
      renderLogs();
    }

    function countAlive() {
      const alive = state.players.filter(p => p.alive);
      const wolves = alive.filter(p => p.role === "werewolf");
      const others = alive.length - wolves.length;
      return { alive, wolves, others };
    }

    function checkWinner() {
      const { wolves, others } = countAlive();
      if (wolves.length === 0 && (wolves.length + others) > 0) {
        state.winner = "village";
        state.phase = "ended";
        addLog("‚úÖ D√ÇN L√ÄNG th·∫Øng ‚Äì kh√¥ng c√≤n Ma S√≥i n√†o.");
      } else if (wolves.length > 0 && wolves.length >= others) {
        state.winner = "wolves";
        state.phase = "ended";
        addLog("‚ò†Ô∏è MA S√ìI th·∫Øng ‚Äì s·ªë S√≥i ‚â• s·ªë ng∆∞·ªùi c√≤n l·∫°i.");
      } else {
        state.winner = null;
      }
      renderPhaseInfo();
      renderWinner();
    }

    function resetNightActions() {
      state.nightActions = {
        wolfTargetId: null,
        guardTargetId: null,
        witchHeal: null,
        witchPoisonTargetId: null,
        mageMuteTargetId: null,
        gamblerBetTargetId: null,
      };
    }

    // ======== SETUP ========

    function populateRoleSelect() {
      const sel = document.getElementById("playerRoleInput");
      ROLES.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = r.label;
        sel.appendChild(opt);
      });
    }

    function addPlayer() {
      const nameInput = document.getElementById("playerNameInput");
      const roleInput = document.getElementById("playerRoleInput");
      const name = nameInput.value.trim();
      const role = roleInput.value;

      if (!name || !role) {
        alert("Nh·∫≠p t√™n v√† ch·ªçn role.");
        return;
      }
      if (state.phase !== "lobby") {
        alert("V√°n ƒë√£ b·∫Øt ƒë·∫ßu, mu·ªën th√™m ng∆∞·ªùi h√£y reset.");
        return;
      }

      if (state.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
        alert("T√™n n√†y ƒë√£ c√≥ trong danh s√°ch.");
        return;
      }

      state.players.push({
        id: Date.now() + Math.random(),
        name,
        role,
        alive: true,
        muted: false,
      });

      nameInput.value = "";
      roleInput.value = "";

      addLog(`‚ûï Th√™m ${name} (${roleLabel(role)})`);
      renderPlayers();
      renderPhaseInfo();
    }

    function toggleAlive(id) {
      const p = state.players.find(p => p.id === id);
      if (!p) return;
      p.alive = !p.alive;
      addLog(`${p.alive ? "‚ù§Ô∏è H·ªìi sinh" : "‚ò†Ô∏è Ch·∫øt (ch·ªânh tay)"}: ${p.name}`);
      renderPlayers();
      checkWinner();
    }

    function removePlayer(id) {
      if (state.phase !== "lobby") {
        alert("V√°n ƒë√£ b·∫Øt ƒë·∫ßu, kh√¥ng x√≥a ng∆∞·ªùi ch∆°i ƒë∆∞·ª£c.");
        return;
      }
      const p = state.players.find(p => p.id === id);
      state.players = state.players.filter(p => p.id !== id);
      addLog(`üóëÔ∏è X√≥a ng∆∞·ªùi ch∆°i: ${p ? p.name : "???"}`);
      renderPlayers();
      renderPhaseInfo();
    }

    // ======== LU·ªíNG GAME ========

    function startGame() {
      if (state.phase !== "lobby") {
        alert("V√°n ƒë√£ b·∫Øt ƒë·∫ßu r·ªìi.");
        return;
      }
      if (state.players.length < 4) {
        alert("C·∫ßn √≠t nh·∫•t 4 ng∆∞·ªùi ch∆°i.");
        return;
      }
      const { wolves, others } = countAlive();
      if (wolves.length === 0 || others === 0) {
        alert("C·∫ßn √≠t nh·∫•t 1 Ma S√≥i v√† 1 ng∆∞·ªùi kh√¥ng ph·∫£i S√≥i.");
        return;
      }

      state.phase = "night";
      state.nightNumber = 1;
      state.dayNumber = 0;
      state.currentNightStepIndex = 0;
      state.winner = null;
      state.witchUsed = false;
      resetNightActions();

      addLog("üåô ƒê√äM 1 b·∫Øt ƒë·∫ßu. M·ªçi ng∆∞·ªùi nh·∫Øm m·∫Øt.");
      renderPhaseInfo();
      renderWinner();
    }

    function startNight() {
      if (state.phase === "lobby") {
        alert("B·∫•m 'B·∫Øt ƒë·∫ßu v√°n' tr∆∞·ªõc.");
        return;
      }
      if (state.phase === "ended") {
        alert("V√°n ƒë√£ k·∫øt th√∫c.");
        return;
      }
      state.phase = "night";
      state.nightNumber = (state.nightNumber || 0) + 1;
      state.currentNightStepIndex = 0;
      resetNightActions();
      state.players.forEach(p => p.muted = false);
      addLog(`üåô ƒê√äM ${state.nightNumber} b·∫Øt ƒë·∫ßu.`);
      renderPlayers();
      renderPhaseInfo();
    }

    function startDay() {
      if (state.phase === "lobby") {
        alert("V√°n ch∆∞a b·∫Øt ƒë·∫ßu.");
        return;
      }
      if (state.phase === "ended") {
        alert("V√°n ƒë√£ k·∫øt th√∫c.");
        return;
      }
      state.phase = "day";
      state.dayNumber = (state.dayNumber || 0) + 1;
      addLog(`‚òÄÔ∏è NG√ÄY ${state.dayNumber} b·∫Øt ƒë·∫ßu.`);
      renderPhaseInfo();
    }

    function nextRoleCall() {
      if (state.phase !== "night") {
        alert("Ch·ªâ d√πng khi ƒëang ƒê√äM.");
        return;
      }
      const aliveRoles = new Set(
        state.players.filter(p => p.alive).map(p => p.role)
      );

      while (state.currentNightStepIndex < NIGHT_CALL_ORDER.length) {
        const step = NIGHT_CALL_ORDER[state.currentNightStepIndex];
        state.currentNightStepIndex++;

        if (step === "witch") {
          if (!aliveRoles.has("witch")) continue;
          let msg;
          if (state.witchUsed) {
            msg = "üß™ Ph√π th·ªßy ƒë√£ d√πng h·∫øt b√¨nh ·ªü ƒë√™m tr∆∞·ªõc, t·ª´ nay ng·ªß.";
          } else {
            msg = "üß™ Ph√π th·ªßy d·∫≠y: c√≥ th·ªÉ C·ª®U n·∫°n nh√¢n S√≥i, ƒê·ªòC 1 ng∆∞·ªùi, d√πng c·∫£ 2, ho·∫∑c kh√¥ng d√πng. Sau ƒë√™m n√†y s·∫Ω h·∫øt b√¨nh.";
          }
          addLog(msg);
          renderPhaseInfo(step);
          return;
        }

        if (!aliveRoles.has(step)) continue;

        let msg = "";
        switch (step) {
          case "mage":
            msg = "üßô Ph√°p s∆∞ d·∫≠y, ch·ªçn 1 ng∆∞·ªùi b·ªã MUTE ng√†y mai.";
            break;
          case "werewolf":
            msg = "üê∫ S√≥i d·∫≠y, ch·ªçn 1 ng∆∞·ªùi ƒë·ªÉ c·∫Øn.";
            break;
          case "seer":
            msg = "üîÆ Ti√™n tri d·∫≠y, ch·ªçn 1 ng∆∞·ªùi ƒë·ªÉ h·ªèi c√≥ ph·∫£i S√≥i.";
            break;
          case "guard":
            msg = "üõ°Ô∏è B·∫£o v·ªá d·∫≠y, ch·ªçn 1 ng∆∞·ªùi ƒë·ªÉ b·∫£o v·ªá.";
            break;
          case "gambler":
            if (state.nightNumber < 2) {
              msg = "üé≤ Con b·∫°c ng·ªß ƒë√™m 1 (ch·ªâ c∆∞·ª£c t·ª´ ƒê√äM 2).";
            } else {
              msg = "üé≤ Con b·∫°c d·∫≠y, c∆∞·ª£c 1 ng∆∞·ªùi: tr√∫ng S√≥i ‚Üí S√≥i ch·∫øt, sai ‚Üí Con b·∫°c ch·∫øt.";
            }
            break;
          case "prince":
            msg = "üëë Ho√†ng t·ª≠: th∆∞·ªùng ch·ªâ ·∫£nh h∆∞·ªüng khi b·ªã treo c·ªï ban ng√†y.";
            break;
        }
        addLog(msg);
        renderPhaseInfo(step);
        return;
      }

      // H·∫øt role -> t√≠nh k·∫øt qu·∫£ ƒë√™m
      applyNightResults();
      addLog("‚úÖ H·∫øt ƒë√™m. Qu·∫£n tr√≤ c√≥ th·ªÉ b·∫•m 'Sang NG√ÄY'.");
      renderPhaseInfo();
    }

    function applyNightResults() {
      const a = state.nightActions;
      const nightNo = state.nightNumber || 1;
      const deaths = [];
      const saved = [];
      let mutedPlayer = null;
      let potionUsedThisNight = false;

      const findAliveById = id => state.players.find(p => p.id === id && p.alive);

      const wolfVictim = findAliveById(a.wolfTargetId);
      const guardTarget = findAliveById(a.guardTargetId);
      const poisonTarget = findAliveById(a.witchPoisonTargetId);
      const healed = a.witchHeal === true;
      const canUsePotion = !state.witchUsed;

      // S√≥i + B·∫£o v·ªá + b√¨nh c·ª©u
      if (wolfVictim) {
        let blocked = false;
        if (guardTarget && guardTarget.id === wolfVictim.id) {
          blocked = true;
          addLog(`üõ°Ô∏è ƒê√™m ${nightNo}: B·∫£o v·ªá che ch·∫Øn ${wolfVictim.name}.`);
        }
        if (canUsePotion && healed && !blocked) {
          saved.push(wolfVictim);
          potionUsedThisNight = true;
          addLog(`üß™ ƒê√™m ${nightNo}: Ph√π th·ªßy C·ª®U ${wolfVictim.name}.`);
        } else if (!blocked && (!canUsePotion || !healed)) {
          deaths.push(wolfVictim);
          addLog(`üê∫ ƒê√™m ${nightNo}: S√≥i gi·∫øt ${wolfVictim.name}.`);
        }
      } else if (canUsePotion && healed) {
        potionUsedThisNight = true;
        addLog(`üß™ ƒê√™m ${nightNo}: Ph√π th·ªßy mu·ªën c·ª©u nh∆∞ng kh√¥ng c√≥ n·∫°n nh√¢n.`);
      }

      // B√¨nh ƒë·ªôc
      if (canUsePotion && poisonTarget) {
        if (!deaths.includes(poisonTarget)) deaths.push(poisonTarget);
        potionUsedThisNight = true;
        addLog(`üíÄ ƒê√™m ${nightNo}: Ph√π th·ªßy ƒê·ªòC ${poisonTarget.name}.`);
      }

      if (potionUsedThisNight) {
        state.witchUsed = true;
        addLog(`üß™ Sau ƒê√äM ${nightNo}: Ph√π th·ªßy ƒë√£ d√πng xong b√¨nh. C√°c ƒë√™m sau s·∫Ω ng·ªß.`);
      }

      // Ph√°p s∆∞ mute
      if (a.mageMuteTargetId) {
        mutedPlayer = findAliveById(a.mageMuteTargetId);
        if (mutedPlayer) {
          mutedPlayer.muted = true;
          addLog(`ü§ê ƒê√™m ${nightNo}: ${mutedPlayer.name} b·ªã MUTE ng√†y mai.`);
        }
      }

      // Con b·∫°c
      if (state.nightNumber >= 2 && a.gamblerBetTargetId) {
        const gambler = state.players.find(p => p.role === "gambler" && p.alive);
        const target = findAliveById(a.gamblerBetTargetId);
        if (gambler && target) {
          if (target.role === "werewolf") {
            if (!deaths.includes(target)) deaths.push(target);
            addLog(`üé≤ ƒê√™m ${nightNo}: Con b·∫°c ƒëo√°n TR√öNG S√≥i (${target.name}).`);
          } else {
            if (!deaths.includes(gambler)) deaths.push(gambler);
            addLog(`üé≤ ƒê√™m ${nightNo}: Con b·∫°c ƒëo√°n sai (${target.name} kh√¥ng ph·∫£i S√≥i) ‚Üí Con b·∫°c ch·∫øt.`);
          }
        }
      }

      // Unique deaths
      const uniqueDeaths = [];
      const seen = new Set();
      deaths.forEach(p => {
        if (p && !seen.has(p.id)) {
          seen.add(p.id);
          uniqueDeaths.push(p);
        }
      });

      if (uniqueDeaths.length === 0 && saved.length === 0 && !mutedPlayer) {
        addLog(`üåô ƒê√™m ${nightNo}: Kh√¥ng ai ch·∫øt, kh√¥ng ai b·ªã mute.`);
      }

      uniqueDeaths.forEach(p => {
        if (p.alive) {
          p.alive = false;
          addLog(`‚ò†Ô∏è ƒê√™m ${nightNo}: ${p.name} ch·∫øt.`);
        }
      });

      resetNightActions();
      renderPlayers();
      checkWinner();
    }

    function forceEndGame() {
      if (!confirm("K·∫øt th√∫c v√°n hi·ªán t·∫°i?")) return;
      state.phase = "ended";
      state.winner = null;
      addLog("üõë Qu·∫£n tr√≤ k·∫øt th√∫c v√°n (manual).");
      renderPhaseInfo();
      renderWinner();
    }

    function resetAll(ask) {
      if (ask && !confirm("Reset to√†n b·ªô v√°n?")) return;
      state.players = [];
      state.phase = "lobby";
      state.nightNumber = 0;
      state.dayNumber = 0;
      state.currentNightStepIndex = 0;
      state.logs = [];
      state.winner = null;
      state.witchUsed = false;
      resetNightActions();
      renderPlayers();
      renderLogs();
      renderPhaseInfo();
      renderWinner();
    }

    // ======== HANDLERS DROPDOWN ========

    function updateNightAction(kind, value) {
      const id = value ? Number(value) : null;
      const p = state.players.find(pl => pl.id === id);

      if (kind === "werewolf") {
        state.nightActions.wolfTargetId = id;
        addLog(p ? `üìå S√≥i d·ª± ƒë·ªãnh c·∫Øn ${p.name}.` : "üìå S√≥i ch∆∞a ch·ªçn n·∫°n nh√¢n.");
      } else if (kind === "guard") {
        state.nightActions.guardTargetId = id;
        addLog(p ? `üìå B·∫£o v·ªá d·ª± ƒë·ªãnh b·∫£o v·ªá ${p.name}.` : "üìå B·∫£o v·ªá ch∆∞a ch·ªçn ai.");
      } else if (kind === "witch_poison") {
        if (state.witchUsed) {
          alert("Ph√π th·ªßy ƒë√£ h·∫øt b√¨nh.");
          return;
        }
        state.nightActions.witchPoisonTargetId = id || null;
        addLog(p ? `üìå Ph√π th·ªßy d·ª± ƒë·ªãnh ƒê·ªòC ${p.name}.` : "üìå Ph√π th·ªßy ch∆∞a ch·ªçn m·ª•c ti√™u ƒë·ªôc.");
      } else if (kind === "mage_mute") {
        state.nightActions.mageMuteTargetId = id;
        addLog(p ? `üìå Ph√°p s∆∞ d·ª± ƒë·ªãnh MUTE ${p.name}.` : "üìå Ph√°p s∆∞ ch∆∞a ch·ªçn ai ƒë·ªÉ mute.");
      } else if (kind === "gambler_bet") {
        state.nightActions.gamblerBetTargetId = id;
        addLog(p ? `üìå Con b·∫°c d·ª± ƒë·ªãnh c∆∞·ª£c v√†o ${p.name}.` : "üìå Con b·∫°c ch∆∞a c∆∞·ª£c ai.");
      }
      renderPhaseInfo();
    }

    function setWitchHeal(val) {
      if (state.witchUsed) {
        alert("Ph√π th·ªßy ƒë√£ h·∫øt b√¨nh.");
        return;
      }
      state.nightActions.witchHeal = val;
      if (val === true) {
        addLog("üß™ Ghi nh·∫≠n: Ph√π th·ªßy s·∫Ω C·ª®U n·∫°n nh√¢n c·ªßa S√≥i (v·∫´n c√≥ th·ªÉ ƒê·ªòC th√™m).");
      } else if (val === false) {
        addLog("üß™ Ghi nh·∫≠n: Ph√π th·ªßy kh√¥ng d√πng b√¨nh c·ª©u (c√≥ th·ªÉ d√πng b√¨nh ƒë·ªôc ho·∫∑c kh√¥ng l√†m g√¨).");
      }
      renderPhaseInfo("witch");
    }

    // ======== RENDER ========

    function renderPlayers() {
      const box = document.getElementById("playersList");
      box.innerHTML = "";
      state.players.forEach(p => {
        const div = document.createElement("div");
        div.className = "player-card" + (p.alive ? "" : " dead");
        div.onclick = () => toggleAlive(p.id);

        const left = document.createElement("div");
        left.innerHTML = `<b>${p.name}</b><br><span class="tag-role">${roleLabel(p.role)}</span>`;

        const right = document.createElement("div");
        const pill = document.createElement("span");
        pill.className = "pill " + (p.alive ? "alive" : "dead");
        pill.textContent = p.alive ? "S·ªêNG" : "CH·∫æT";
        right.appendChild(pill);
        if (p.muted && p.alive) {
          const m = document.createElement("span");
          m.className = "pill muted";
          m.textContent = "MUTE";
          right.appendChild(m);
        }
        const del = document.createElement("button");
        del.textContent = "X";
        del.style.marginLeft = "6px";
        del.style.fontSize = "0.7rem";
        del.style.padding = "2px 6px";
        del.style.width = "auto";
        del.className = "danger";
        del.onclick = (e) => { e.stopPropagation(); removePlayer(p.id); };
        right.appendChild(del);

        div.appendChild(left);
        div.appendChild(right);
        box.appendChild(div);
      });

      document.getElementById("playerCount").textContent = state.players.length;
    }

    function renderLogs() {
      const box = document.getElementById("logBox");
      box.innerHTML = "";
      state.logs.forEach(l => {
        const div = document.createElement("div");
        div.className = "log-line";
        div.textContent = l;
        box.appendChild(div);
      });
    }

    function renderPhaseInfo(currentNightStep) {
      const phaseBox = document.getElementById("phaseInfo");
      const statusBox = document.getElementById("statusText");
      const actionPanel = document.getElementById("nightActionPanel");

      const { alive, wolves, others } = countAlive();
      let label = "";
      if (state.phase === "lobby") label = "‚è≥ ƒêang setup ng∆∞·ªùi ch∆°i";
      else if (state.phase === "night") label = `üåô ƒê√äM ${state.nightNumber || 1}`;
      else if (state.phase === "day") label = `‚òÄÔ∏è NG√ÄY ${state.dayNumber || 1}`;
      else label = "üèÅ V√ÅN K·∫æT TH√öC";

      phaseBox.innerHTML = `<div class="phase-label">${label}</div>`;
      statusBox.innerHTML =
        `C√≤n s·ªëng: <strong>${alive.length}</strong> ¬∑ S√≥i: <strong>${wolves.length}</strong> ¬∑ Ng∆∞·ªùi kh√°c: <strong>${others}</strong>`;

      // Enable / disable buttons
      document.getElementById("startGameBtn").disabled =
        state.phase !== "lobby" || state.players.length < 4;
      document.getElementById("nightBtn").disabled = state.phase === "ended";
      document.getElementById("dayBtn").disabled = state.phase === "ended";
      document.getElementById("callBtn").disabled =
        state.phase !== "night" || state.phase === "ended";
      document.getElementById("endBtn").disabled = state.phase === "lobby";

      // Render action panel
      actionPanel.innerHTML = "";
      if (state.phase !== "night") return;

      const step =
        currentNightStep ||
        NIGHT_CALL_ORDER[state.currentNightStepIndex - 1] ||
        null;
      if (!step) return;

      const aliveList = countAlive().alive;

      if (step === "werewolf") {
        const opts = aliveList
          .filter(p => p.role !== "werewolf")
          .map(p =>
            `<option value="${p.id}" ${state.nightActions.wolfTargetId === p.id ? "selected" : ""}>
              ${p.name}
            </option>`
          ).join("");
        actionPanel.innerHTML = `
          <b>S√≥i c·∫Øn ai?</b>
          <select onchange="updateNightAction('werewolf', this.value)">
            <option value="">(Ch∆∞a ch·ªçn)</option>
            ${opts}
          </select>
          <div class="hint">Ch·ªçn n·∫°n nh√¢n b·ªã S√≥i c·∫Øn.</div>
        `;
      } else if (step === "guard") {
        const opts = aliveList.map(p =>
          `<option value="${p.id}" ${state.nightActions.guardTargetId === p.id ? "selected" : ""}>
            ${p.name}
          </option>`
        ).join("");
        actionPanel.innerHTML = `
          <b>B·∫£o v·ªá b·∫£o v·ªá ai?</b>
          <select onchange="updateNightAction('guard', this.value)">
            <option value="">(Ch∆∞a ch·ªçn)</option>
            ${opts}
          </select>
          <div class="hint">N·∫øu tr√πng n·∫°n nh√¢n S√≥i c·∫Øn ‚Üí ng∆∞·ªùi ƒë√≥ kh√¥ng ch·∫øt.</div>
        `;
      } else if (step === "witch") {
        if (state.witchUsed) {
          actionPanel.innerHTML = `
            <b>Ph√π th·ªßy</b>
            <div class="hint">ƒê√£ d√πng h·∫øt b√¨nh (c·ª©u/ƒë·ªôc) ·ªü ƒë√™m tr∆∞·ªõc ‚Üí c√°c ƒë√™m sau ng·ªß.</div>
          `;
        } else {
          const victim = state.players.find(p => p.id === state.nightActions.wolfTargetId);
          const victimName = victim ? victim.name : "Ch∆∞a r√µ / Kh√¥ng c√≥";
          const opts = aliveList.map(p =>
            `<option value="${p.id}" ${state.nightActions.witchPoisonTargetId === p.id ? "selected" : ""}>
              ${p.name}
            </option>`
          ).join("");
          actionPanel.innerHTML = `
            <b>Ph√π th·ªßy ‚Äì C·ª©u / ƒê·ªôc</b>
            <div class="small">N·∫°n nh√¢n S√≥i c·∫Øn: <b>${victimName}</b></div>
            <div class="row-2" style="margin-top:4px;">
              <button class="secondary" onclick="setWitchHeal(false)">Kh√¥ng c·ª©u</button>
              <button class="primary" onclick="setWitchHeal(true)">C·ª®U n·∫°n nh√¢n</button>
            </div>
            <div style="margin-top:6px;">Ch·ªçn ng∆∞·ªùi ƒë·ªÉ ƒê·ªòC (c√≥ th·ªÉ k·∫øt h·ª£p v·ªõi C·ª®U):</div>
            <select onchange="updateNightAction('witch_poison', this.value)">
              <option value="">(Kh√¥ng ƒë·ªôc ai)</option>
              ${opts}
            </select>
            <div class="hint">
              Trong ƒë√™m n√†y c√≥ th·ªÉ kh√¥ng d√πng b√¨nh, ch·ªâ C·ª®U, ch·ªâ ƒê·ªòC ho·∫∑c C·∫¢ HAI.
              Sau khi d√πng b·∫•t k·ª≥ b√¨nh n√†o, c√°c ƒë√™m sau Ph√π th·ªßy kh√¥ng d√πng ƒë∆∞·ª£c n·ªØa.
            </div>
          `;
        }
      } else if (step === "mage") {
        const opts = aliveList.map(p =>
          `<option value="${p.id}" ${state.nightActions.mageMuteTargetId === p.id ? "selected" : ""}>
            ${p.name}
          </option>`
        ).join("");
        actionPanel.innerHTML = `
          <b>Ph√°p s∆∞ ‚Äì MUTE ai?</b>
          <select onchange="updateNightAction('mage_mute', this.value)">
            <option value="">(Kh√¥ng mute ai)</option>
            ${opts}
          </select>
          <div class="hint">Ng∆∞·ªùi b·ªã ch·ªçn s·∫Ω b·ªã MUTE, kh√¥ng ƒë∆∞·ª£c ph√°t bi·ªÉu NG√ÄY h√¥m sau (t√πy lu·∫≠t b·∫°n).</div>
        `;
      } else if (step === "gambler") {
        if (state.nightNumber < 2) {
          actionPanel.innerHTML = `
            <b>Con b·∫°c</b>
            <div class="hint">ƒê√™m 1 ng·ªß, ch·ªâ c∆∞·ª£c t·ª´ ƒê√äM 2.</div>
          `;
        } else {
          const opts = aliveList.map(p =>
            `<option value="${p.id}" ${state.nightActions.gamblerBetTargetId === p.id ? "selected" : ""}>
              ${p.name}
            </option>`
          ).join("");
          actionPanel.innerHTML = `
            <b>Con b·∫°c ‚Äì C∆∞·ª£c v√†o ai?</b>
            <select onchange="updateNightAction('gambler_bet', this.value)">
              <option value="">(Kh√¥ng c∆∞·ª£c)</option>
              ${opts}
            </select>
            <div class="hint">
              N·∫øu ng∆∞·ªùi ƒë∆∞·ª£c c∆∞·ª£c l√† S√≥i ‚Üí S√≥i ch·∫øt. N·∫øu kh√¥ng ph·∫£i S√≥i ‚Üí Con b·∫°c ch·∫øt.
            </div>
          `;
        }
      } else if (step === "seer") {
        actionPanel.innerHTML = `
          <b>Ti√™n tri</b>
          <div class="hint">
            Ti√™n tri ch·ªâ h·ªèi qu·∫£n tr√≤ xem 1 ng∆∞·ªùi c√≥ ph·∫£i S√≥i hay kh√¥ng. Kh√¥ng c·∫ßn ghi v√†o app, b·∫°n t·ª± nh·ªõ.
          </div>
        `;
      } else if (step === "prince") {
        actionPanel.innerHTML = `
          <b>Ho√†ng t·ª≠</b>
          <div class="hint">
            Th∆∞·ªùng ch·ªâ ·∫£nh h∆∞·ªüng khi b·ªã treo c·ªï ban ng√†y (kh√¥ng ch·∫øt, l·ªô th√¢n ph·∫≠n...). B·∫°n x·ª≠ l√Ω b·∫±ng mi·ªáng.
          </div>
        `;
      }
    }

    function renderWinner() {
      const box = document.getElementById("winnerText");
      if (!state.winner) {
        box.textContent = "";
        box.className = "winner-text";
        return;
      }
      if (state.winner === "village") {
        box.textContent = "üéâ D√ÇN L√ÄNG TH·∫ÆNG!";
        box.className = "winner-text winner-village";
      } else {
        box.textContent = "üî• MA S√ìI TH·∫ÆNG!";
        box.className = "winner-text winner-wolves";
      }
    }

    // ======== INIT ========

    populateRoleSelect();
    renderPlayers();
    renderLogs();
    renderPhaseInfo();
  </script>
</body>
</html>
